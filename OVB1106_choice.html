<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hide and Seek Coin Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }

    .hidden {
      display: none !important;
    }

    button {
      margin: 10px 8px;
      padding: 10px 22px;
      font-size: 16px;
      cursor: pointer;
      border: 1px solid #ccc;
      background-color: #f8f8f8;
      border-radius: 6px;
    }

    button:hover {
      background-color: #e8e8e8;
    }

    h2, h3 {
      margin-top: 0;
    }

    .center {
      text-align: center;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 400px;
      margin: 0 auto;
    }

    form input {
      padding: 7px;
      font-size: 15px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    /* Observation grid - bigger images for kids */
    .observation-outcome-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 12px;
      justify-items: center;
      margin: 20px auto;
      max-width: 800px;
    }

    .outcome-image {
      width: 120px;
      height: 120px;
      object-fit: contain;
      border-radius: 8px;
    }

    .friend-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-top: 10px;
    }

    .friend-header img {
      width: 90px;
      height: 90px;
      object-fit: contain;
    }

    .friend-choose-container {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin: 30px auto 10px;
      align-items: flex-start;
    }

    .friend-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px;
      border-radius: 10px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s, transform 0.1s;
    }

    .friend-card img.friend-main {
      width: 130px;
      height: 130px;
      object-fit: contain;
      margin-bottom: 8px;
    }

    .choice-outcome-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 6px;
      margin-top: 8px;
      justify-items: center;
    }

    .choice-outcome-grid img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      border-radius: 6px;
    }

    .friend-card:hover {
      border-color: #999;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .friend-card.selected {
      border-color: #28a745;
      box-shadow: 0 0 10px rgba(40,167,69,0.4);
    }

    /* Inline follow-up panel (no blackout) */
    #choice-followup {
      margin: 20px auto 0;
      padding: 16px 18px;
      max-width: 750px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background-color: #fffdf7;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      font-size: 15px;
    }

    #choice-followup h3 {
      margin-top: 0;
    }

    #choice-followup textarea {
      width: 100%;
      min-height: 70px;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      resize: vertical;
      font-size: 14px;
      margin-bottom: 10px;
    }

    #choice-followup .scale-group {
      margin-bottom: 10px;
    }

    #choice-followup label {
      margin-right: 10px;
      font-size: 14px;
    }

    /* Simple custom alert modal */
    .custom-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }

    .custom-modal-content {
      background-color: #fff;
      padding: 20px 24px;
      border-radius: 8px;
      text-align: center;
      max-width: 400px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    }

    .custom-modal.hidden {
      display: none !important;
    }
  </style>
</head>
<body>
<div id="experiment-container">

  <!-- 1. Participant Info FIRST -->
  <div id="participant-info-screen">
    <h2 class="center">Who do you want to play hide-and-seek with?</h2>
    <form id="info-form">
      <label>Test Date
        <input type="text" name="test_date" placeholder="mm/dd/yyyy" required>
      </label>
      <label>Experimenter initials
        <input type="text" name="experimenter" required>
      </label>
      <label>Participant ID
        <input type="text" name="SID" required>
      </label>
      <label>Participant Age (years)
        <input type="number" name="age" min="4" max="18" required>
      </label>
      <label>Participant Sex
        <input type="text" name="sex" placeholder="M/F" required>
      </label>
      <button type="submit">Continue</button>
    </form>
  </div>

  <!-- 2. Start screen (Ready / Decline) -->
  <div id="start-screen" class="hidden center">
    <h2>Ready to play a hiding-and-seek coin game?</h2>
    <p>
      In this game, I will introduce you to two friends, <strong>Alice</strong> and <strong>Lily</strong>, who love to hide.
      They will give you a coin every time you guess where they are hiding correctly.
    </p>
    <p>Your job is to figure out who is easier to predict so you can try to win the most coins!</p>

    <div style="display:flex; justify-content:center; gap:40px; margin:20px 0;">
      <div>
        <img src="https://github.com/ey242/OVB/raw/main/public/stim/alice.png"
             alt="Alice" style="width:140px; height:140px; object-fit:contain;">
        <div style="margin-top:6px; font-weight:bold;">This is Alice</div>
      </div>
      <div>
        <img src="https://github.com/ey242/OVB/raw/main/public/stim/lily.png"
             alt="Lily" style="width:140px; height:140px; object-fit:contain;">
        <div style="margin-top:6px; font-weight:bold;">This is Lily</div>
      </div>
    </div>

    <button id="start-ready-button">I'm ready to play</button>
    <button id="start-decline-button">I don't want to play</button>
  </div>

  <!-- 3. (Unused consent screen left in case you reinstate it) -->
  <div id="consent-screen" class="hidden">
    <!-- intentionally not wired in this version -->
  </div>

  <!-- 4. Observation screen -->
  <div id="observation-screen" class="hidden">
    <div class="friend-header">
      <img id="obs-friend-avatar" alt="Friend">
      <h2 id="obs-title"></h2>
    </div>
    <p id="obs-text" class="center"></p>
    <div id="observation-outcomes-display" class="observation-outcome-grid"></div>
    <div class="center">
      <button id="obs-next-button">Show next hiding spot</button>
    </div>
  </div>

  <!-- 5. Choice screen (pick friend) -->
  <div id="choice-screen" class="hidden">
    <h2 class="center">Which friend do you want to play with?</h2>
    <p class="center">
      Choose the friend you think will help you win the <strong>most coins</strong>.
      Remember: they give you a coin every time you guess where they are hiding correctly.
    </p>
    <div class="friend-choose-container">
      <div id="choose-alice" class="friend-card">
        <img src="https://github.com/ey242/OVB/raw/main/public/stim/alice.png"
             alt="Alice" class="friend-main">
        <strong>Alice</strong>
        <div id="alice-outcomes" class="choice-outcome-grid"></div>
      </div>

      <div id="choose-lily" class="friend-card">
        <img src="https://github.com/ey242/OVB/raw/main/public/stim/lily.png"
             alt="Lily" class="friend-main">
        <strong>Lily</strong>
        <div id="lily-outcomes" class="choice-outcome-grid"></div>
      </div>
    </div>

    <!-- Inline follow-up (no blackout) -->
    <div id="choice-followup" class="hidden">
      <h3 id="followup-title"></h3>
      <div class="scale-group">
        <label for="why-text"><strong>Why did you pick this friend?</strong></label>
        <textarea id="why-text" placeholder="You can tell us what you noticed."></textarea>
      </div>
      <div class="scale-group">
        <strong>How sure are you?</strong><br>
        <label><input type="radio" name="sure" value="1"> 1 (not sure at all)</label>
        <label><input type="radio" name="sure" value="2"> 2 (a little sure)</label>
        <label><input type="radio" name="sure" value="3"> 3 (kind of sure)</label>
        <label><input type="radio" name="sure" value="4"> 4 (very sure)</label>
        <label><input type="radio" name="sure" value="5"> 5 (super sure, as sure as you can be)</label>
      </div>
      <div class="scale-group">
        <strong>How many coins do you think you can win with this friend?</strong><br>
        <label><input type="radio" name="coins" value="all"> All of the coins</label><br>
        <label><input type="radio" name="coins" value="many"> Many coins</label><br>
        <label><input type="radio" name="coins" value="some"> Some coins</label><br>
        <label><input type="radio" name="coins" value="few"> Very few coins</label><br>
        <label><input type="radio" name="coins" value="none"> No coins</label>
      </div>
      <div class="center">
        <button id="followup-submit-button">Finish</button>
      </div>
    </div>
  </div>

  <!-- 7. Final screen -->
  <div id="final-screen" class="hidden center">
    <h2>All done!</h2>
    <p>Thank you for playing our hiding-and-seek coin game.</p>
    <p>Your answers have been saved.</p>
    <button id="final-download-button">Download data</button>
  </div>
</div>

<!-- Custom alert modal -->
<div id="custom-alert-modal" class="custom-modal hidden">
  <div class="custom-modal-content">
    <p id="custom-alert-message"></p>
    <button id="custom-alert-ok-button">OK</button>
  </div>
</div>

<script>
  // ================== Utility: show/hide screens ==================
  function showScreen(id) {
    document.querySelectorAll('#experiment-container > div')
      .forEach(div => div.classList.add('hidden'));
    const el = document.getElementById(id);
    if (el) el.classList.remove('hidden');
  }

  function showCustomAlert(message, cb) {
    const modal = document.getElementById('custom-alert-modal');
    const msg = document.getElementById('custom-alert-message');
    const ok = document.getElementById('custom-alert-ok-button');
    msg.textContent = message;
    modal.classList.remove('hidden');

    function handle() {
      modal.classList.add('hidden');
      ok.removeEventListener('click', handle);
      if (cb) cb();
    }
    ok.addEventListener('click', handle);
  }

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  // ================== Friend & pattern configuration ==================

  const friends = {
    alice: {
      name: 'Alice',
      avatar: 'https://github.com/ey242/OVB/raw/main/public/stim/alice.png',
      doors: ['pink', 'green'],
      doorImgs: {
        pink: 'https://github.com/ey242/OVB/raw/main/public/stim/alicepink.png',
        green: 'https://github.com/ey242/OVB/raw/main/public/stim/alicegreen.png'
      }
    },
    lily: {
      name: 'Lily',
      avatar: 'https://github.com/ey242/OVB/raw/main/public/stim/lily.png',
      doors: ['purple', 'blue'],
      doorImgs: {
        purple: 'https://github.com/ey242/OVB/raw/main/public/stim/lilypurple.png',
        blue: 'https://github.com/ey242/OVB/raw/main/public/stim/lilyblue.png'
      }
    }
  };

  const STRUCTURED_PATTERNS = ['alternating', 'AAB', 'ABB', 'AABB'];

  let participantInfo = {};
  let config = {
    friendOrder: [],
    structuredFriend: null,
    randomFriend: null,
    structuredPattern: null,
    patternDoors: null,
    sequences: {}
  };

  let currentObsFriendIndex = 0; // 0 or 1
  let currentObsIndex = 0;

  let choiceData = {
    chosenFriend: null,
    why: '',
    sure: '',
    coinsExpect: ''
  };

  // ================== Pattern helpers ==================

  function generateStructuredSequence(pattern, A, B, length = 6) {
    let base;
    if (pattern === 'alternating') base = ['A', 'B'];
    else if (pattern === 'AAB') base = ['A', 'A', 'B'];
    else if (pattern === 'ABB') base = ['A', 'B', 'B'];
    else if (pattern === 'AABB') base = ['A', 'A', 'B', 'B'];
    else base = ['A', 'B'];

    const seq = [];
    for (let i = 0; i < length; i++) {
      const letter = base[i % base.length];
      seq.push(letter === 'A' ? A : B);
    }
    return seq;
  }

  function lettersFromSeq(seq, A, B) {
    return seq.map(x => (x === A ? 'A' : 'B'));
  }

  function isBannedPattern(letters) {
    const s = letters.join('');
    const banned = [
      'AAABBB', 'BBBAAA',
      'ABABAB', 'BABABA',
      'AABAAB', 'BBAABB',
      'ABBABB', 'BAABBA'
    ];
    return banned.includes(s);
  }

  function generateConstrainedRandom(A, B, length = 6, avoidSeq = null) {
    for (let attempt = 0; attempt < 200; attempt++) {
      const seq = [];
      let last = null;
      let run = 0;

      for (let i = 0; i < length; i++) {
        let choice;
        if (run >= 3) {
          choice = (last === A) ? B : A;
        } else {
          choice = (Math.random() < 0.5) ? A : B;
        }
        run = (choice === last) ? run + 1 : 1;
        last = choice;
        seq.push(choice);
      }

      const letters = lettersFromSeq(seq, A, B);
      if (isBannedPattern(letters)) continue;
      if (avoidSeq && letters.join('') === avoidSeq.letters) continue;

      return seq;
    }

    // fallback
    const fallback = [];
    for (let i = 0; i < length; i++) {
      fallback.push(Math.random() < 0.5 ? A : B);
    }
    return fallback;
  }

  // ================== Initialize comparison config ==================

  function initComparison() {
    // 1. Randomize friend observation order
    config.friendOrder = ['alice', 'lily'];
    shuffle(config.friendOrder);

    // 2. Pick structured pattern
    config.structuredPattern =
      STRUCTURED_PATTERNS[Math.floor(Math.random() * STRUCTURED_PATTERNS.length)];

    // 3. Randomly assign which friend is structured
    config.structuredFriend =
      Math.random() < 0.5 ? config.friendOrder[0] : config.friendOrder[1];
    config.randomFriend = (config.structuredFriend === 'alice') ? 'lily' : 'alice';

    // 4. Structured friend A/B mapping
    const sFriend = friends[config.structuredFriend];
    const sDoors = [...sFriend.doors];
    shuffle(sDoors);
    config.patternDoors = { A: sDoors[0], B: sDoors[1] };

    // 5. Structured sequence
    const structSeq = generateStructuredSequence(
      config.structuredPattern,
      config.patternDoors.A,
      config.patternDoors.B,
      6
    );

    // 6. Random friend sequence (constrained)
    const rFriend = friends[config.randomFriend];
    const rA = rFriend.doors[0];
    const rB = rFriend.doors[1];
    const avoidLetters = lettersFromSeq(structSeq, config.patternDoors.A, config.patternDoors.B).join('');
    const randomSeq = generateConstrainedRandom(rA, rB, 6, { letters: avoidLetters });

    // 7. Store sequences for both
    config.sequences[config.structuredFriend] = structSeq;
    config.sequences[config.randomFriend] = randomSeq;

    // --- Clear logging of assignment ---
    console.log('=== HIDE-AND-SEEK CONFIGURATION ===');
    console.log('Friend order (observation):', config.friendOrder);
    console.log(`Alice pattern: ${
      config.structuredFriend === 'alice' ? config.structuredPattern : 'random'
    }`, 'sequence:', (config.sequences.alice || []).join('-'));
    console.log(`Lily pattern: ${
      config.structuredFriend === 'lily' ? config.structuredPattern : 'random'
    }`, 'sequence:', (config.sequences.lily || []).join('-'));
    console.log('Structured friend:', config.structuredFriend);
    console.log('Random friend:', config.randomFriend);
    console.log('Structured pattern:', config.structuredPattern,
                'A =', config.patternDoors.A, 'B =', config.patternDoors.B);
    console.log('===================================');
  }

  // ================== Observation flow ==================

  function startFriendObservation(friendIndex) {
    currentObsFriendIndex = friendIndex;
    currentObsIndex = 0;

    const key = config.friendOrder[friendIndex];
    const friend = friends[key];
    const seq = config.sequences[key];

    const avatar = document.getElementById('obs-friend-avatar');
    const title = document.getElementById('obs-title');
    const text = document.getElementById('obs-text');
    const grid = document.getElementById('observation-outcomes-display');

    avatar.src = friend.avatar;
    avatar.alt = friend.name;
    title.textContent = `Watch how ${friend.name} hides.`;
    text.textContent =
      `${friend.name} will hide 6 times. Click the button to see where ${friend.name} is hiding each time.`;
    grid.innerHTML = '';

    const oldBtn = document.getElementById('obs-next-button');
    const newBtn = oldBtn.cloneNode(true);
    oldBtn.parentNode.replaceChild(newBtn, oldBtn);
    newBtn.textContent = 'Show next hiding spot';

    newBtn.addEventListener('click', () => {
      if (currentObsIndex < 6) {
        const door = seq[currentObsIndex];
        const img = document.createElement('img');
        img.className = 'outcome-image';
        img.src = friend.doorImgs[door];
        img.alt = `${friend.name} at ${door}`;
        grid.appendChild(img);
        currentObsIndex++;

        if (currentObsIndex === 6) {
          newBtn.textContent = 'Done';
        }
      } else {
        if (currentObsFriendIndex === 0) {
          startFriendObservation(1);
        } else {
          showChoiceScreen();
        }
      }
    });

    showScreen('observation-screen');
  }

  // ================== Choice & follow-up ==================

  function showChoiceScreen() {
    // reset selection & followup UI
    document.querySelectorAll('.friend-card').forEach(c => c.classList.remove('selected'));
    document.getElementById('choice-followup').classList.add('hidden');
    document.getElementById('why-text').value = '';
    document.querySelectorAll('input[name="sure"]').forEach(r => r.checked = false);
    document.querySelectorAll('input[name="coins"]').forEach(r => r.checked = false);
    choiceData = { chosenFriend: null, why: '', sure: '', coinsExpect: '' };

    // render 6 observed outcomes for each friend
    const aliceGrid = document.getElementById('alice-outcomes');
    const lilyGrid = document.getElementById('lily-outcomes');
    aliceGrid.innerHTML = '';
    lilyGrid.innerHTML = '';

    ['alice', 'lily'].forEach(key => {
      const friend = friends[key];
      const seq = config.sequences[key] || [];
      const grid = key === 'alice' ? aliceGrid : lilyGrid;

      seq.forEach(door => {
        const img = document.createElement('img');
        img.src = friend.doorImgs[door];
        img.alt = `${friend.name} hiding at ${door}`;
        grid.appendChild(img);
      });
    });

    const aliceCard = document.getElementById('choose-alice');
    const lilyCard = document.getElementById('choose-lily');

    function selectFriend(key) {
      choiceData.chosenFriend = key;
      aliceCard.classList.toggle('selected', key === 'alice');
      lilyCard.classList.toggle('selected', key === 'lily');

      const fName = friends[key].name;
      const follow = document.getElementById('choice-followup');
      const title = document.getElementById('followup-title');
      title.textContent = `You chose ${fName}!`;
      follow.classList.remove('hidden');
    }

    aliceCard.onclick = () => selectFriend('alice');
    lilyCard.onclick = () => selectFriend('lily');

    document.getElementById('followup-submit-button').onclick = () => {
      if (!choiceData.chosenFriend) {
        showCustomAlert('Please choose Alice or Lily first.');
        return;
      }

      const why = document.getElementById('why-text').value.trim();
      const sure = (document.querySelector('input[name="sure"]:checked') || {}).value || '';
      const coins = (document.querySelector('input[name="coins"]:checked') || {}).value || '';

      if (!why) {
        showCustomAlert('Please tell us why you picked this friend.');
        return;
      }
      if (!sure) {
        showCustomAlert('Please tell us how sure you are.');
        return;
      }
      if (!coins) {
        showCustomAlert('Please tell us how many coins you think you can win.');
        return;
      }

      choiceData.why = why;
      choiceData.sure = sure;
      choiceData.coinsExpect = coins;

      showScreen('final-screen');
    };

    showScreen('choice-screen');
  }

  // ================== Data export ==================

  function downloadCSV() {
    const header = [
      'Test Date','Experimenter','ParticipantID','Age','Sex',
      'FriendOrder1','FriendOrder2',
      'StructuredFriend','RandomFriend','StructuredPattern',
      'AliceSeq','LilySeq',
      'ChosenFriend','Why','Sure(1-5)','CoinsExpectation'
    ];

    const aliceSeq = (config.sequences.alice || []).join('-');
    const lilySeq = (config.sequences.lily || []).join('-');

    const row = [
      participantInfo.test_date || '',
      participantInfo.experimenter || '',
      participantInfo.SID || '',
      participantInfo.age || '',
      participantInfo.sex || '',
      config.friendOrder[0] || '',
      config.friendOrder[1] || '',
      config.structuredFriend || '',
      config.randomFriend || '',
      config.structuredPattern || '',
      aliceSeq,
      lilySeq,
      choiceData.chosenFriend || '',
      '"' + (choiceData.why || '').replace(/"/g, '""') + '"',
      choiceData.sure || '',
      choiceData.coinsExpect || ''
    ];

    const csv = header.join(',') + '\n' + row.join(',');
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `hide_and_seek_${participantInfo.SID || 'data'}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ================== Top-level wiring ==================

  // 1) Participant info FIRST
  document.getElementById('info-form').addEventListener('submit', (e) => {
    e.preventDefault();
    participantInfo = Object.fromEntries(new FormData(e.target));
    console.log('Participant Info:', participantInfo);
    initComparison();                 // set up patterns
    showScreen('start-screen');
  });

  // 2) Start screen buttons
  document.getElementById('start-ready-button').addEventListener('click', () => {
    startFriendObservation(0);        // first friend in randomized order
  });

  document.getElementById('start-decline-button').addEventListener('click', () => {
    showCustomAlert('Okay, you donâ€™t have to play.', () => {});
  });

  // 3) Final download button
  document.getElementById('final-download-button').addEventListener('click', () => {
    downloadCSV();
    showCustomAlert('Data downloaded. You are all done!');
  });

  // Show participant info screen on load
  showScreen('participant-info-screen');
</script>
</body>
</html>
