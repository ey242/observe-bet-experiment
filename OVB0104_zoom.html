<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Observe-Bet-for-children</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }

      .hidden {
        display: none;
      }

      button {
        margin: 10px 0;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
      }

      .button-container {
        display: flex;
        justify-content: center;
        gap: 20px;

        margin-top: 10px;
        margin-bottom: 10px;
      }

      .button-container button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        border: 1px solid #ccc;
        background-color: #f8f8f8;
        border-radius: 5px;
      }

      .button-container button:hover {
        background-color: #e8e8e8;
      }

      video {
        max-width: 100%;
        height: auto;
      }

      .slider-container {
        margin-top: 20px;
      }

      input[type="range"] {
        width: 100%;
      }

      form {
        display: flex;
        flex-direction: column;
      }

      form input {
        margin-bottom: 10px;
        padding: 5px;
      }

      .game-container {
        display: grid;
        gap: 20px; /* Increased gap between groups */
        justify-content: center;
        max-width: 1200px; /* Increased max-width to allow for more spacing */
        margin: 0 auto;
        padding: 20px; /* Added padding to the container */
      }

      .group {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 15px; /* Added padding to each group */
        border: 1px solid #e0e0e0; /* Optional: adds a light border around each group */
        border-radius: 8px; /* Optional: rounds the corners of the groups */
        background-color: #f9f9f9; /* Optional: gives a slight background color to each group */
      }

      .group.large {
        width: 220px; /* Slightly increased width */
        height: 220px; /* Slightly increased height */
        margin: 10px; /* Reduced margin as we're using grid gap */
      }

      .doors {
        display: flex;
      }

      .icon {
        width: 50px;
        height: 50px;
        margin: 2px;
        cursor: pointer;
      }

      .group.large .icon {
        width: 100px;
        height: 100px;
      }

      .chosen-image {
        width: 100px;
        height: 100px;
      }

      .group.large .chosen-image {
        width: 200px;
        height: 200px;
      }

      #instruction1,
      #instruction2,
      #instruction3,
      #instruction4 {
        text-align: center;
      }

      .button-container {
        display: flex;
        justify-content: center;
        margin-top: 10px;
        margin-bottom: 10px;
      }

      video {
        display: block;
        margin: 0 auto;
      }

      .instruction-page {
        text-align: center;
        margin: 20px auto;
        max-width: 600px;
      }

      .continue-button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
      }

      .episode-summary {
        text-align: center;
        margin: 20px auto;
        max-width: 800px;
      }

      .summary-title {
        font-size: 24px;
        margin-bottom: 10px;
      }

      .summary-coins {
        font-size: 18px;
        margin-bottom: 20px;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        grid-template-rows: repeat(4, auto);
        gap: 10px;
        justify-content: center;
        align-items: start;
        max-width: 100%;
        margin: 0 auto;
      }

      .summary-cell {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        text-align: center;
      }

      .summary-img {
        width: 50px;
        height: 50px;
        object-fit: contain;
        margin-bottom: 5px;
      }

      .summary-label,
      .summary-number {
        font-size: 12px;
        margin: 2px 0;
      }

      @media (max-width: 768px) {
        .summary-grid {
          grid-template-columns: repeat(5, 1fr);
        }

        .summary-img {
          width: 40px;
          height: 40px;
        }

        .summary-label,
        .summary-number {
          font-size: 10px;
        }
      }

      /* Adjust the grid layout for different screen sizes and number of groups */
      @media (min-width: 768px) {
        .game-container[data-groups="4"],
        .game-container[data-groups="5"] {
          grid-template-columns: repeat(2, 1fr);
        }

        .game-container[data-groups="20"] {
          grid-template-columns: repeat(4, 1fr);
        }
      }

      @media (min-width: 1024px) {
        .game-container[data-groups="20"] {
          grid-template-columns: repeat(5, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div id="experiment-container">
      <div id="participant-info">
        <h2>Participant Information</h2>
        <!-- Corrected form structure -->
        <form id="info-form">
          <label for="test_date">Test Date</label>
          <input type="text" id="test_date" name="test_date" placeholder="mm/dd/yyyy" required>
          <label for="experimenter">Experimenter name</label>
          <input type="text" id="experimenter" name="experimenter" required>
          <label for="SID">Participant ID</label>
          <input type="text" id="SID" name="SID" required>
          <label for="age">Participant Age (years)</label>
          <input type="text" id="age" name="age" required>
          <label for="sex">Participant Sex</label>
          <input type="text" id="sex" name="sex" placeholder="M/F" required>
          <button type="submit">Submit</button>
        </form>
      </div>
      <div id="consent-screen" class="hidden">

        <p>
          <strong>Cognitive Development and Learning Lab</strong>
          <br> Department of Psychology <br> UC Berkeley
        </p>
        <p> Dear Participants, </p>
        <p> My name is Alison Gopnik. I am a Professor in the Department of Psychology at the University of California, Berkeley. I am doing a research study, and I want to ask if you will be a part of it. </p>
        <p>
          <strong> What is a research study? </strong>
        </p>
        <p> A research study is when people like me collect a lot of information about a certain thing to find out more about it. This letter tells you about my study so you can decide if you want to be in it. Before you decide, you can talk about it with your parents or anyone else you like. If you have any questions about the research, just ask us. </p>
        <p>
          <strong> Why are we doing this study? </strong>
        </p>
        <p> I and the other researchers on my team are doing this study to find out more about how people learn. This study is not part of your schoolwork, and you won't get graded on it. </p>
        <p>
          <strong> Why are we talking to you about this study? </strong>
        </p>
        <p> We're asking a lot of children your age if they would like to help. We're inviting you to take part because you are the right age for this study. </p>
        <p>
          <strong> What will happen if you are in the study? </strong>
        </p>
        <p> If you agree to be in the study and your parents say it's okay, you might be asked to play our computer game and we will ask you questions about it. We play a lot of different games with children to find out more about how they learn. This game in particular will take about 15 minutes. </p>
        <p>
          <strong> If you don't want to be in the study, what can you do instead? </strong>
        </p>
        <p> If you don't want to do the study anymore, please let us know and you can keep doing whatever activity you were doing before. </p>
        <p>
          <strong> Will good things happen from being in this study? </strong>
        </p>
        <p> Being in this study won't really change anything for you. But we hope that what we find out from this research will help us figure out how people learn. </p>
        <p>
          <strong> Are there things you might not like about being in the study? </strong>
        </p>
        <p> You might get bored or tired and decide that you don't want to finish the study activities. If this happens, just tell us you want to stop. </p>
        <p>
          <strong> Will you get paid for being in the study? </strong>
        </p>
        <p> No, you will not be paid for being in this study. </p>
        <p>
          <strong> Do you have to be in the study? </strong>
        </p>
        <p> No, you don't! Research is something you do only if you want to. Nothing bad will happen if you don't want to be in the study. Just tell us. Whether you decide to participate or not, either way will have no effect on your grades at school, or anything else. And remember, you can always change your mind later if you don't want to be in the study any more. </p>
        <p>
          <strong> Do you have any questions? </strong>
        </p>
        <p> You can ask questions about this study at any time, now or later. You can talk to me, or your parents, or someone else if you like. You can contact me, Alison Gopnik, at gopnik@berkeley.edu. Or you can contact our lab manager at gopniklabmanager@berkeley.edu. Or you can contact U.C. Berkeley's Committee for the Protection of Human Subjects at 510-642-7461 or subjects@berkeley.edu. </p>
        <p>
          <strong>Consent Statement</strong>
        </p>
        <p> If you agree to participate, please click the consent button below. Thank you very much for your time and consideration. </p>
        <p> By selecting the <strong>Consent</strong> button below, I acknowledge that I am 7 or older, have read this consent form, and I agree to take part in the game conducted by the research lab of Alison Gopnik. </p>
        <p> If you do NOT agree to participate in this study, please click the <strong>Decline</strong> button below. </p>
        <button id="consent-button">Consent</button>
        <button id="decline-button">Decline</button>
      </div>

      <!-- Add this new div for the probability selection screen -->
      <div id="probability-selection" class="hidden">
        <h2>Select Probability Condition</h2>
        <p>Please choose the probability condition for this experiment:</p>
        <div class="button-container">
          <button class="prob-button" data-probability="0.5">0.5</button>
          <button class="prob-button" data-probability="0.8">0.8</button>
          <button class="prob-button" data-probability="1.0">1.0</button>
        </div>
      </div>

      <div id="instruction1" class="instruction-div hidden">
        <div class="video-container">
          <video width="600" height="300" controls>
            <source src="https://github.com/ey242/OVB/raw/main/public/stim/Scene%201-%20Practice.mp4" type="video/mp4"> Your browser does not support the video tag.
          </video>
        </div>
        <div class="button-container">
          <button class="number-button" data-value="0">0</button>
          <button class="number-button" data-value="1">1</button>
          <button class="number-button" data-value="2">2</button>
          <button class="number-button" data-value="3">3</button>
        </div>
        <div class="question-text">
          <p>What happens if you meet the kind elf?</p>
          <p>What happens if you meet the mean monster?</p>
        </div>
      </div>
      <div id="instruction2" class="instruction-div hidden">
        <div class="video-container">
          <video width="600" height="300" controls id="probability-video">
            <source src="" type="video/mp4"> Your browser does not support the video tag.
          </video>
        </div>
        <div class="button-container">
          <button class="number-button" data-value="0">0</button>
          <button class="number-button" data-value="1">1</button>
          <button class="number-button" data-value="2">2</button>
          <button class="number-button" data-value="3">3</button>
        </div>
        <div class="question-text">
          <p>Will the kind elf change the door she hides behind?</p>
          <p>Does the kind elf like to hide behind one door more than the other?</p>
          <p>Will the mean monster change the door he hides behind?</p>
          <p>Does the kind elf like to hide behind one door more than the other?</p>
          <p>Does the mean monster like to hide behind one door more than the other?</p>
        </div>
      </div>
      <div id="instruction3" class="instruction-div hidden">
        <div class="video-container">
          <video width="600" height="300" controls>
            <source src="https://github.com/ey242/OVB/raw/main/public/stim/Practice-%20Part%202.mp4" type="video/mp4"> Your browser does not support the video tag.
          </video>
        </div>
        <div class="button-container">
          <button class="number-button" data-value="0">0</button>
          <button class="number-button" data-value="1">1</button>
          <button class="number-button" data-value="2">2</button>
          <button class="number-button" data-value="3">3</button>
        </div>
        <div class="question-text">
          <p>If you choose a door, will you find out who is behind it right away? </p> 
          <p>If you choose a door, when will you find out if you win a coin? </p> 
        </div>
      </div>
      <div id="instruction4" class="instruction-div hidden">
        <div class="video-container">
          <video width="600" height="300" controls>
            <source src="https://github.com/ey242/OVB/raw/main/public/stim/Practice-%20Part%203.mp4" type="video/mp4"> Your browser does not support the video tag.
          </video>
        </div>
        <div class="button-container">
          <button class="number-button" data-value="0">0</button>
          <button class="number-button" data-value="1">1</button>
          <button class="number-button" data-value="2">2</button>
          <button class="number-button" data-value="3">3</button>
        </div>
        <div class="question-text">
          <p>Do you win a coin for choosing to watch where the kind elf is behind the door?</p>
        </div>
      </div>

      <div id="elfslider1" class="hidden">
        <img src="https://github.com/ey242/OVB/raw/main/public/stim/elfdoors.png" alt="Elf Doors" style="width: 750px;">
        <p>
          <center>Can you guess which door the kind elf prefers to hide behind? If the elf only hides behind the brown door and never the blue door, we will drag it all the way to where the brown door is. If the elf only hides behind the blue door and never the brown door, we will drag it all the way to the other end where the blue door is. If the elf hides behind both doors sometimes, then we’ll move the slider somewhere in the middle! Now, I'm going to drag the slider from the brown door to the blue door. You tell me when to stop! If you think the elf likes the brown door more, say stop when we're closer to the brown side. If you think the elf likes the blue door more, say stop when we're closer to the blue side. Ready? Let’s start!</center>
        </p>
        <div class="slider-container" style="width: 94%;">          
          <input type="range" min="0" max="100" value="50" class="slider" id="elfSlider">
        </div>
        <button class="next-button" data-next="wolfslider1">Next</button>
      </div>


      <div id="wolfslider1" class="hidden">
        <img src="https://github.com/ey242/OVB/raw/main/public/stim/wolfdoors.png" alt="Wolf Doors" style="width: 750px;">
        <p>
          <center>Can you guess which door the mean monster prefers to hide behind? If the monster only hides behind the brown door and never the blue door, we will drag it all the way to where the brown door is. If the monster only hides behind the blue door and never the brown door, we will drag it all the way to the other end where the blue door is. If the monster hides behind both doors sometimes, then we’ll move the slider somewhere in the middle! Now, I'm going to drag the slider from the brown door to the blue door. You tell me when to stop! If you think the monster likes the brown door more, say stop when we're closer to the brown side. If you think the monster likes the blue door more, say stop when we're closer to the blue side. Ready? Let’s start!</center>
        </p>
        <div class="slider-container" style="width: 94%;">
                    <input type="range" min="0" max="100" value="50" class="slider" id="wolfSlider">
        </div>
        <button class="next-button" data-next="pretrial">Next</button>
      </div>




      <div id="pretrial" class="hidden">
        <p id="practice-rounds-text">Now we are going to enter the practice game. This is to practice for your real game later where you will get to win coins. So you want to learn as much as you can in the practice game to do well in the real game!</p>
        <p id="rounds-instruction">This practice game has 4 rounds. In each round, you can decide to either watch who is behind the doors or choose one door to win coins.</p>
        <p>You will find out how many coins you win at the end of the game.</p>
        <p>Are you ready to play the game?</p>
        <button id="ready-button">Ready</button>
      </div>
    </div>
    <div id="game-screen" class="hidden">
      <!-- <h2>Icon Selection Game</h2> -->
      <div id="gameContainer" class="game-container"></div>
    </div>

    <div id="instruction-page-1" class="instruction-page hidden">
      <!-- <h2 class="summary-title">Episode 1/2</h2> -->
      <div id="episode-1-summary"></div>
      <button class="continue-button" data-next="instruction-page-2">Continue</button>
    </div>

    <div id="instruction-page-2" class="instruction-page hidden">
      <div class="video-container">
        <video width="600" height="300" controls>
          <source src="https://github.com/ey242/OVB/raw/main/public/stim/Scene%201-%20Testing.mp4" type="video/mp4"> Your browser does not support the video tag.
        </video>
      </div>
      <div class="button-container">
        <button class="bumber-button" data-value="0" data-next="instruction-page-3">0</button>
        <button class="bumber-button" data-value="1" data-next="instruction-page-3">1</button>
        <button class="bumber-button" data-value="2" data-next="instruction-page-3">2</button>
        <button class="bumber-button" data-value="3" data-next="instruction-page-3">3</button>
      </div>
      <div class="question-text">
        <p>Will the kind princess change the door she hides behind? Remember, the princess hides behind the same doors just like the kind elf that you just saw.</p>
        <p>if p=0.8: Does the kind princess prefer hiding behind one door more than the other?</p>
      </div>
    </div>
    <div id="instruction-page-3" class="instruction-page hidden">
      <p> This is a new game with 20 rounds. <br> You will win a coin everytime you guess where the princess is correctly. </p>
      <button class="continue-button" data-next="game-screen-2">Ready</button>
    </div>
    <div id="game-screen-2" class="hidden">
      <!-- <h2>Icon Selection Game - Round 2</h2> -->
      <div id="gameContainer2" class="game-container"></div>
    </div>
    <div id="instruction-page-5" class="instruction-page hidden">
      <img src="https://github.com/ey242/OVB/raw/main/public/stim/princessdoors.png" alt="Wolf Doors" style="width: 750px;">
      <p>
        <center>Can you guess which door the kind princess prefers to hide behind? If the princess only hides behind the brown door and never the blue door, we will drag it all the way to where the brown door is. If the princess only hides behind the blue door and never the brown door, we will drag it all the way to the other end where the blue door is. If the princess hides behind both doors sometimes, then we’ll move the slider somewhere in the middle! Now, I'm going to drag the slider from the brown door to the blue door. You tell me when to stop! If you think the princess likes the brown door more, say stop when we're closer to the brown side. If you think the princess likes the blue door more, say stop when we're closer to the blue side. Ready? Let’s start!</center>
      </p>
      <div class="slider-container" style="width: 127%;">
        <input type="range" min="0" max="100" value="50" class="slider" id="princessSlider">
      </div>
      <button class="continue-button" data-next="instruction-page-6">Continue</button>
    </div>
    <div id="instruction-page-6" class="instruction-page hidden">
      <img src="https://github.com/ey242/OVB/raw/main/public/stim/thiefdoors.png" alt="Wolf Doors" style="width: 750px;">
      <p>
        <div style="text-align: center;"> Can you guess which door the mean thief prefers to hide behind? If the thief only hides behind the brown door and never the blue door, we will drag it all the way to where the brown door is. If the thief only hides behind the blue door and never the brown door, we will drag it all the way to the other end where the blue door is. If the thief hides behind both doors sometimes, then we’ll move the slider somewhere in the middle! Now, I'm going to drag the slider from the brown door to the blue door. You tell me when to stop! If you think the thief likes the brown door more, say stop when we're closer to the brown side. If you think the thief likes the blue door more, say stop when we're closer to the blue side. Ready? Let’s start! </div>
        </p>
        <div class="slider-container" style="width: 127%;">
          <input type="range" min="0" max="100" value="50" class="slider" id="thiefSlider">
        </div>
        <button class="continue-button" data-next="end-screen">Continue</button>
      </div>
<div id="end-screen" class="hidden">
  <h2 class="summary-title"></h2>
  <div id="episode-2-summary"></div>
  <button class="continue-button" data-next="final-screen">Continue</button>
</div>
    </div>


    <script>
      function addQuitButton() {
        const quitButton = document.createElement('button');
        quitButton.textContent = 'Quit';
        quitButton.id = 'quit-button';
        quitButton.style.position = 'fixed';
        quitButton.style.top = '10px';
        quitButton.style.right = '10px';
        quitButton.style.zIndex = '1000';
        quitButton.addEventListener('click', handleQuit);
        document.body.appendChild(quitButton);
      }

      function handleQuit() {
        if (confirm('Are you sure you want to quit? Your progress will be saved.')) {
          savePartialDataToCSV();
          alert('Thank you for participating. Your partial data has been saved.');
          window.location.reload();
        }
      }

      function savePartialDataToCSV() {
        const header = [
          'Test Date', 'Experimenter Name', 'Participant ID', 'Participant Age', 'Participant Sex',
          'Selected Probability', 'Elf Slider Value', 'Wolf Slider Value', 'Princess Slider Value', 'Thief Slider Value',
          'Episode', 'Round', 'Choice', 'Reality', 'Coins Earned'
        ];

        const dataRows = [];

        const baseInfo = [
          participantInfo.test_date || '',
          participantInfo.experimenter || '',
          participantInfo.SID || '',
          participantInfo.age || '',
          participantInfo.sex || '',
          selectedProbability || '',
          document.getElementById('elfSlider')?.value || '',
          document.getElementById('wolfSlider')?.value || '',
          document.getElementById('princessSlider')?.value || '',
          document.getElementById('thiefSlider')?.value || ''
        ];

        function addEpisodeRows(episode, choices, realities) {
          if (choices.length === 0) return; 
          
          for (let i = 0; i < choices.length; i++) {
            let coinsEarned = 0;
            if (choices[i] !== 'observe') {
              coinsEarned = choices[i] === realities[i] ? 1 : 0;
            }

            dataRows.push([
              ...baseInfo,
              episode,
              i + 1,
              choices[i],
              realities[i],
              coinsEarned
            ]);
          }
        }

        addEpisodeRows(1, choices1, realities1);
        addEpisodeRows(2, choices2, realities2);

        if (dataRows.length === 0) {
          dataRows.push([...baseInfo, '', '', '', '', '']);
        }

        const csvContent = [header, ...dataRows].map(row => row.join(',')).join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) {
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", `participant_${participantInfo.SID || 'unknown'}_partial_data.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }

      const n_arms = 2;
      const n_steps = 4;
      const n_episodes = 2;
      let i_step = 1;
      let i_episode = 0;
      let rewards_tally = 0;
      let rewards_total_1 = 0;
      let rewards_total_2 = 0;
      let total_rewards_tally = 0;
      let ps = [0.5, 0.5];
      let transitions_ep = [];

      let groupsInteracted = 0;
      let currentGameScreen = 'game-screen';
      const totalGroups = {
        'game-screen': 4,
        'game-screen-2': 20
      };

      let practiceTrials = [];
      let mainTrials = [];

      let selectedProbability;
      let practiceTrialCount;
function generateTrials(numTrials, probability) {
        let trials = [];
        
        // Determine if it's a practice round based on numTrials (4 or 5)
        const isPracticeRound = (numTrials === 4 || numTrials === 5);

        if (isPracticeRound) {
            if (probability === 0.5) {
                // p=0.5 practice: 2 brown, 2 blue, shuffled
                // Corrected: Ensure exactly 2 of each door for 4 trials
                trials = ['brown', 'brown', 'blue', 'blue'];
                // Shuffle for independence of sequence
                for (let i = trials.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [trials[i], trials[j]] = [trials[j], trials[i]];
                }
            } else if (probability === 0.8) {
                // p=0.8 practice: 4 dominant, 1 rare, shuffled
                const dominantDoor = Math.random() < 0.5 ? 'brown' : 'blue';
                const rareDoor = dominantDoor === 'brown' ? 'blue' : 'brown';
                
                trials = Array(4).fill(dominantDoor);
                trials.push(rareDoor);
                
                // Store dominantDoor for main trials to maintain consistency
                window.dominantDoor = dominantDoor; 

                // Shuffle for any kind of sequence
                for (let i = trials.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [trials[i], trials[j]] = [trials[j], trials[i]];
                }
            } else if (probability === 1.0) {
                // p=1.0 practice: 4 rounds, each door randomly chosen independently
                for (let i = 0; i < numTrials; i++) {
                    trials.push(Math.random() < 0.5 ? 'brown' : 'blue');
                }
            }
        } else { // Main trials (numTrials = 20)
            if (probability === 1.0) {
                // For main trials with p=1.0, a single fixed door for the whole episode
                // If window.fixedDoor is not set, initialize it.
                if (!window.fixedDoor) {
                    window.fixedDoor = Math.random() < 0.5 ? 'brown' : 'blue';
                }
                trials = Array(numTrials).fill(window.fixedDoor);
            } else if (probability === 0.8) {
                // Main trials for 0.8: 16 dominant, 4 rare, shuffled. Use the dominant door from practice.
                const dominantDoor = window.dominantDoor; // Retrieve dominant door set during practice
                const rareDoor = dominantDoor === 'brown' ? 'blue' : 'brown';

                trials = Array(16).fill(dominantDoor);
                for (let i = 0; i < 4; i++) {
                    trials.push(rareDoor);
                }
                for (let i = trials.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [trials[i], trials[j]] = [trials[j], trials[i]];
                }
            } else { // probability === 0.5
                // Main trials for 0.5: exactly 10 of one door, 10 of the other, shuffled
                const door1 = 'brown';
                const door2 = 'blue';
                trials = Array(10).fill(door1).concat(Array(10).fill(door2));
                // Shuffle the trials
                for (let i = trials.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [trials[i], trials[j]] = [trials[j], trials[i]];
                }
            }
        }
        
        return trials;
      }

      function initializeTrials(probability) {
        rewards_total_1 = 0;
        rewards_total_2 = 0;
        
        practiceTrials = generateTrials(practiceTrialCount, probability);
        mainTrials = generateTrials(20, probability);

      // Replace all occurrences of "brown" with "red" and "blue" with "yellow"
      mainTrials = mainTrials.map(trial => {
        if (typeof trial === 'string') {
            return trial.replace(/brown/g, 'red').replace(/blue/g, 'yellow');
        } else if (Array.isArray(trial)) {
            return trial.map(item => typeof item === 'string' ? 
                item.replace(/brown/g, 'red').replace(/blue/g, 'yellow') : item);
        }
        return trial;
    });

        console.log('Practice Trials:', practiceTrials);
        console.log('Main Trials:', mainTrials);
      }

      function setup() {
        rewards_tally = 0;
        transitions_ep = [];
        i_step = 1;
      }

      function showScreen(id) {
        document.querySelectorAll('#experiment-container > div, #game-screen, #instruction-page-1, #instruction-page-2, #instruction-page-3, #game-screen-2, #instruction-page-4, #instruction-page-5, #instruction-page-6, #end-screen').forEach(screen => {
          screen.classList.add('hidden');
        });
        document.getElementById(id).classList.remove('hidden');
      }

      function setGridLayout(container, n) {
        if (n === 5) {
          container.style.gridTemplateColumns = 'repeat(3, auto)';
          container.style.gridTemplateRows = 'repeat(2, auto)';
        } else {
          const columns = n === 4 ? 2 : 5;
          container.style.gridTemplateColumns = `repeat(${columns}, auto)`;
        }
      }

      function createIcon(type) {
        const icon = document.createElement('img');
        icon.className = 'icon';
        icon.src = `https://github.com/ey242/OVB/raw/main/public/stim/${type}.png`;
        icon.alt = type;
        icon.dataset.type = type;
        icon.style.pointerEvents = 'auto';  
        return icon;
      }

      function createGroup(index, isLarge = false) {
        const group = document.createElement('div');
        group.className = 'group';
        if (isLarge) group.classList.add('large');
        group.dataset.index = index;
        group.dataset.interacted = 'false';

        const glasses = createIcon('glasses');
        const doors = document.createElement('div');
        doors.className = 'doors';
        const blueDoor = createIcon('bluedoor');
        const brownDoor = createIcon('browndoor');

        doors.appendChild(blueDoor);
        doors.appendChild(brownDoor);
        group.appendChild(glasses);
        group.appendChild(doors);

        return group;
      }

      function createGroupM(index, isLarge = false) {
        const group = document.createElement('div');
        group.className = 'group';
        if (isLarge) group.classList.add('large');
        group.dataset.index = index;
        group.dataset.interacted = 'false';

        const glasses = createIcon('glasses');
        const doors = document.createElement('div');
        doors.className = 'doors';
        const yellowDoor = createIcon('yellowdoor');
        const redDoor = createIcon('reddoor');

        doors.appendChild(yellowDoor);
        doors.appendChild(redDoor);
        group.appendChild(glasses);
        group.appendChild(doors);

        return group;
      }

      function replaceWithChosenImage(group, type) {
        const chosenImage = document.createElement('img');
        chosenImage.className = 'chosen-image';
        
        const currentTrials = currentGameScreen === 'game-screen' ? practiceTrials : mainTrials;
        const currentIndex = parseInt(group.dataset.index);
        const currentReality = currentTrials[currentIndex];
        
        if (currentGameScreen === 'game-screen-2') {
          switch(type) {
            case 'observe':
              chosenImage.src = currentReality === 'red'
                ? 'https://github.com/ey242/OVB/raw/main/public/stim/princessred.png'
                : 'https://github.com/ey242/OVB/raw/main/public/stim/princessyellow.png';
              break;
            case 'yellow':
              chosenImage.src = 'https://github.com/ey242/OVB/raw/main/public/stim/yellowdoor.png';
              break;
            case 'red':
              chosenImage.src = 'https://github.com/ey242/OVB/raw/main/public/stim/reddoor.png';
              break;
            default:
              console.error('Unexpected type in replaceWithChosenImage:', type);
              return;
          }
        } else {
          switch(type) {
            case 'observe':
              chosenImage.src = currentReality === 'brown'
                ? 'https://github.com/ey242/OVB/raw/main/public/stim/elfbrown.png'
                : 'https://github.com/ey242/OVB/raw/main/public/stim/elfblue.png';
              break;
            case 'blue':
              chosenImage.src = 'https://github.com/ey242/OVB/raw/main/public/stim/Choose2.png';
              break;
            case 'brown':
              chosenImage.src = 'https://github.com/ey242/OVB/raw/main/public/stim/Choose1.png';
              break;
            default:
              console.error('Unexpected type in replaceWithChosenImage:', type);
              return;
          }
        }
        
        chosenImage.alt = `Chosen ${type}`;
        group.innerHTML = '';
        group.appendChild(chosenImage);
      }
      
      let lastClickedIndex = -1;

      function handleIconClick(event) {
        const icon = event.target.closest('.icon');  
        if (!icon) return;  

        const group = icon.closest('.group');
        if (!group) return;

        const currentIndex = parseInt(group.dataset.index);

        // Check if this is the next valid group to click
        if (currentIndex !== lastClickedIndex + 1) {
          alert("Please select icons from left to right, top to bottom.");
          return;
        }

        if (group.dataset.interacted === 'true') return;

        event.stopPropagation();  

        let chosenType;
        switch (icon.dataset.type) {
          case 'glasses':
            chosenType = 'observe';
            break;
          case 'bluedoor':
            chosenType = 'blue';
            break;
          case 'browndoor':
            chosenType = 'brown';
            break;
          case 'reddoor':
            chosenType = 'red';
            break;
          case 'yellowdoor':
            chosenType = 'yellow';
            break;
          default:
            console.error('Unexpected icon type:', icon.dataset.type);
            return;  
        }

        console.log('Chosen type:', chosenType);  

        replaceWithChosenImage(group, chosenType);

        group.dataset.interacted = 'true';
        lastClickedIndex = currentIndex;
        groupsInteracted++;

        const currentChoices = currentGameScreen === 'game-screen' ? choices1 : choices2;
        const currentRealities = currentGameScreen === 'game-screen' ? realities1 : realities2;
        const currentTrials = currentGameScreen === 'game-screen' ? practiceTrials : mainTrials;

        currentChoices.push(chosenType);

        if (chosenType === 'observe') {
          currentRealities.push(currentTrials[groupsInteracted - 1]);
        } else {
          const trialOutcome = currentTrials[groupsInteracted - 1];
          currentRealities.push(trialOutcome);
          if (chosenType === trialOutcome) {
            if (currentGameScreen === 'game-screen') {
              rewards_total_1++;
            } else {
              rewards_total_2++;
            }
          }
        }

        console.log('Current choices:', currentChoices);
        console.log('Current realities:', currentRealities);

        if (groupsInteracted === totalGroups[currentGameScreen]) {
          showContinueButton();
        }
      }

      function showContinueButton() {
        const continueButton = document.createElement('button');
        continueButton.textContent = 'Continue';
        continueButton.id = 'continue-button';
        continueButton.style.display = 'block';
        continueButton.style.margin = '20px auto';
        continueButton.addEventListener('click', handleContinue);

        const container = document.getElementById(currentGameScreen);
        container.appendChild(continueButton);
      }

      function handleContinue() {
        if (currentGameScreen === 'game-screen') {
          showScreen('elfslider1');
        } else if (currentGameScreen === 'game-screen-2') {
          showScreen('instruction-page-5');
        }
        groupsInteracted = 0;
        lastClickedIndex = -1;
        document.querySelectorAll('.group').forEach(g => g.dataset.interacted = 'false');
        document.getElementById('continue-button').remove();
      }

      function initializeGame(containerId, gridSize) {
        const gameContainer = document.getElementById(containerId);
        console.log(containerId=="gameContainer")
        gameContainer.innerHTML = '';
        gameContainer.dataset.groups = gridSize;
        groupsInteracted = 0;
        lastClickedIndex = -1;

        setGridLayout(gameContainer, gridSize);
if (containerId=="gameContainer"){
  for (let i = 0; i < gridSize; i++) {
          const isLarge = gridSize <= 5;
          const group = createGroup(i, isLarge);
          gameContainer.appendChild(group);
        }
} else{
  for (let i = 0; i < gridSize; i++) {
          const isLarge = gridSize <= 5;
          const group = createGroupM(i, isLarge);
          gameContainer.appendChild(group);
        }
}
      
        gameContainer.addEventListener('click', handleIconClick);
      }


      function saveData(){

      }

      function transitions_pairing(transition) {
        const hundreds = Math.floor(transition / 100);
        const tens = Math.floor(transition / 10) % 10;
        const ones = transition % 10;
        return (hundreds) * 5 + (tens) * 2 + (ones % 2) + 1;
      }

      function createEpisodeSummary(episodeNumber, choices, realities, coins) {
        console.log("Episode:", episodeNumber);
        console.log("Choices:", choices);
        console.log("Realities:", realities);

        const container = document.createElement('div');
        container.className = 'episode-summary';

        const coinsEarned = document.createElement('p');
        coinsEarned.textContent = `Coins earned this episode: ${coins}`;
        coinsEarned.className = 'summary-coins';
        container.appendChild(coinsEarned);

        const grid = document.createElement('div');
        grid.className = 'summary-grid';

        for (let i = 0; i < 20; i++) {
          const cell = document.createElement('div');
          cell.className = 'summary-cell';

          if (i < choices.length) {
            const realityLabel = document.createElement('div');
            realityLabel.textContent = 'Reality';
            realityLabel.className = 'summary-label';
            cell.appendChild(realityLabel);

            const realityImg = document.createElement('img');
            if (episodeNumber === 2) {
              realityImg.src = realities[i] === 'red'
                ? 'https://github.com/ey242/OVB/raw/main/public/stim/princessred.png'
                : 'https://github.com/ey242/OVB/raw/main/public/stim/princessyellow.png';
            } else {
              realityImg.src = realities[i] === 'brown'
                ? 'https://github.com/ey242/OVB/raw/main/public/stim/chosenelf.png'
                : 'https://github.com/ey242/OVB/raw/main/public/stim/elfcoinblue.png';
            }
            realityImg.alt = 'Reality';
            realityImg.className = 'summary-img';
            cell.appendChild(realityImg);

            const choiceLabel = document.createElement('div');
            choiceLabel.textContent = 'Your Choice';
            choiceLabel.className = 'summary-label';
            cell.appendChild(choiceLabel);

            const choiceImg = document.createElement('img');
          
          if (episodeNumber === 2) {
            if (choices[i] === 'observe') {
              choiceImg.src = 'https://github.com/ey242/OVB/raw/main/public/stim/Choose3.png';
            } else if (choices[i] === 'red') {
              choiceImg.src = 'https://github.com/ey242/OVB/raw/main/public/stim/reddoor.png';
            } else {
              choiceImg.src = 'https://github.com/ey242/OVB/raw/main/public/stim/yellowdoor.png';
            }
          } else {
            if (choices[i] === 'observe') {
              choiceImg.src = 'https://github.com/ey242/OVB/raw/main/public/stim/Choose3.png';
            } else if (choices[i] === 'brown') {
              choiceImg.src = 'https://github.com/ey242/OVB/raw/main/public/stim/Choose1.png';
            } else {
              choiceImg.src = 'https://github.com/ey242/OVB/raw/main/public/stim/Choose2.png';
            }
          }
            choiceImg.alt = choices[i];
            choiceImg.className = 'summary-img';
            cell.appendChild(choiceImg);

            const numberLabel = document.createElement('div');
            numberLabel.textContent = i + 1;
            numberLabel.className = 'summary-number';
            cell.appendChild(numberLabel);
          } else {
            // Fill empty cells for consistency
            cell.style.visibility = 'hidden';
          }

          grid.appendChild(cell);
        }

        container.appendChild(grid);
        return container;
      }

      function showEpisodeSummary(episodeNumber) {
        const choices = episodeNumber === 1 ? choices1 : choices2;
        const realities = episodeNumber === 1 ? realities1 : realities2;
        const coins = episodeNumber === 1 ? rewards_total_1 : rewards_total_2;
        const summaryContainer = episodeNumber === 1 ? 'episode-1-summary' : 'episode-2-summary';

        const summary = createEpisodeSummary(episodeNumber, choices, realities, coins);
        document.getElementById(summaryContainer).innerHTML = '';
        document.getElementById(summaryContainer).appendChild(summary);
      }

      let choices1 = [];
      let choices2 = [];
      let realities1 = [];
      let realities2 = [];

      let participantInfo = {};

      document.getElementById('info-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        participantInfo = Object.fromEntries(formData);
        console.log('Participant Info:', participantInfo);
        showScreen('consent-screen');
      });

      document.getElementById('consent-button').addEventListener('click', () => {
        addQuitButton(); 
        showScreen('probability-selection');
      });

      document.querySelectorAll('.prob-button').forEach(button => {
        button.addEventListener('click', (e) => {
          selectedProbability = parseFloat(e.target.dataset.probability);
          console.log('Selected probability:', selectedProbability);
          practiceTrialCount = selectedProbability === 0.8 ? 5 : 4;
          initializeTrials(selectedProbability);
          
          // Set the correct video source based on the selected probability
          const probabilityVideo = document.getElementById('probability-video');
          if (selectedProbability === 0.5) {
            probabilityVideo.src = "https://github.com/ey242/OVB/raw/main/public/stim/Practice-%200.5.mp4";
          } else if (selectedProbability === 0.8) {
            probabilityVideo.src = "https://github.com/ey242/OVB/raw/main/public/stim/Practice-%200.75.mp4";
          } else if (selectedProbability === 1.0) {
            probabilityVideo.src = "https://github.com/ey242/OVB/raw/main/public/stim/Practice-1.0.mp4";
          }
          
          // Update the instruction text based on the selected probability
          const roundsInstruction = document.getElementById('rounds-instruction');
          if (selectedProbability === 0.8) {
            roundsInstruction.textContent = "This practice game has 5 rounds. In each round, you can decide to either watch who is behind the doors or choose one door to win coins.";
          } else {
            roundsInstruction.textContent = "This practice game has 4 rounds. In each round, you can decide to either watch who is behind the doors or choose one door to win coins.";
          }
          
          addQuitButton();
          showScreen('instruction1');
        });
      });

      document.querySelectorAll('.number-button').forEach(button => {
        button.addEventListener('click', (e) => {
          const currentScreen = e.target.closest('div[id^="instruction"]').id;
          const nextScreen = {
            'instruction1': 'instruction2',
            'instruction2': 'instruction3',
            'instruction3': 'instruction4',
            'instruction4': 'pretrial'
          }[currentScreen];
          if (nextScreen) {
            console.log(`Selected answer: ${e.target.dataset.value}`);
            showScreen(nextScreen);
          }
        });
      });

      document.getElementById('ready-button').addEventListener('click', () => {
        showScreen('game-screen');
        currentGameScreen = 'game-screen';
        initializeGame('gameContainer', practiceTrialCount);
      });

      document.querySelectorAll('.next-button, .continue-button').forEach(button => {
        button.addEventListener('click', (e) => {
          const nextScreen = e.target.dataset.next;
          if (nextScreen) {
            if (e.target.closest('div').id === 'elfslider1') {
              console.log(`Elf slider value: ${document.getElementById('elfSlider').value}`);
              showScreen('wolfslider1');
            } else if (e.target.closest('div').id === 'wolfslider1') {
              console.log(`Wolf slider value: ${document.getElementById('wolfSlider').value}`);
              showEpisodeSummary(1);
              showScreen('instruction-page-1');
            } else if (nextScreen === 'instruction-page-2') {
              showScreen('instruction-page-2');
            } else if (nextScreen === 'instruction-page-3') {
              showScreen('instruction-page-3');
            } else if (nextScreen === 'game-screen-2') {
              currentGameScreen = 'game-screen-2';
              initializeGame('gameContainer2', totalGroups[currentGameScreen]);
              showScreen('game-screen-2');
            } else if (e.target.closest('div').id === 'instruction-page-5') {
              console.log(`Princess slider value: ${document.getElementById('princessSlider').value}`);
              showScreen('instruction-page-6');
            } else if (e.target.closest('div').id === 'instruction-page-6') {
              console.log(`Wolf slider value: ${document.getElementById('thiefSlider').value}`);
              showEpisodeSummary(2);
              showScreen('end-screen');
            }
          }
        });
      });

      document.querySelectorAll('.bumber-button').forEach(button => {
        button.addEventListener('click', function() {
          const value = this.getAttribute('data-value');
          console.log('Selected value:', value);
          const nextPage = this.getAttribute('data-next');
          if (nextPage) {
            showScreen(nextPage);
          }
        });
      });

      document.getElementById('princessSlider').addEventListener('change', function() {
        console.log('Princess slider value:', this.value);
      });

      document.getElementById('thiefSlider').addEventListener('change', function() {
        console.log('Thief slider value:', this.value);
      });

      function saveDataToCSV() {
        // Create the header row
        const header = [
          'Test Date', 'Experimenter Name', 'Participant ID', 'Participant Age', 'Participant Sex',
          'Selected Probability', 'Elf Slider Value', 'Wolf Slider Value', 'Princess Slider Value', 'Thief Slider Value',
          'Episode', 'Round', 'Choice', 'Reality', 'Coins Earned'
        ];

        // Create the data rows
        const dataRows = [];

        // Add participant info
        const baseInfo = [
          participantInfo.test_date || '',
          participantInfo.experimenter || '',
          participantInfo.SID || '',
          participantInfo.age || '',
          participantInfo.sex || '',
          selectedProbability || '',
          document.getElementById('elfSlider')?.value || '',
          document.getElementById('wolfSlider')?.value || '',
          document.getElementById('princessSlider')?.value || '',
          document.getElementById('thiefSlider')?.value || ''
        ];


        function addEpisodeRows(episode, choices, realities) {
          if (choices.length === 0) return; 
          
          for (let i = 0; i < choices.length; i++) {
            let coinsEarned = 0;
            if (choices[i] !== 'observe') {
              coinsEarned = choices[i] === realities[i] ? 1 : 0;
            }

            dataRows.push([
              ...baseInfo,
              episode,
              i + 1,
              choices[i],
              realities[i],
              coinsEarned
            ]);
          }
        }

        addEpisodeRows(1, choices1, realities1);
        addEpisodeRows(2, choices2, realities2);

        if (dataRows.length === 0) {
          dataRows.push([...baseInfo, '', '', '', '', '']);
        }

        const csvContent = [header, ...dataRows].map(row => row.join(',')).join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) {
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", `participant_${participantInfo.SID}_data.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }

      document.querySelector('#end-screen .continue-button').addEventListener('click', (e) => {
        saveDataToCSV();
        alert('Thank you for participating! Your data has been saved.');
      });

      showScreen('participant-info');
    </script>
  </body>
</html>
